#!/usr/bin/env python

import urllib
import urllib2
import sys
import re
from BeautifulSoup import BeautifulSoup

nomode = ''
bold = ''
rev = ''
sitm = ''
ritm = ''

if sys.stdout.isatty():
    nomode = '\033[0m'
    try:
        import curses
        curses.setupterm()
        bold = curses.tigetstr('bold')
        rev  = curses.tigetstr('rev')
        sitm = curses.tigetstr('sitm')
        ritm = curses.tigetstr('ritm')
    except:
        bold = '\033[1m'
        rev  = '\033[7m'
        sitm = '\033[3m'
        ritm = '\033[23m'

if len(sys.argv) == 1:
    print 'Usage: leo <words>'
    exit()

words = ' '.join(sys.argv[1:])

def process(s):
    s = re.sub(r'<b>',       bold,   s)
    s = re.sub(r'</b>',      nomode, s)
    s = re.sub(r'<i>',       sitm,   s)
    s = re.sub(r'</i>',      ritm,   s)
    s = re.sub(r'<small>',   '',     s)
    s = re.sub(r'</small>',  '',     s)
    s = re.sub(r'<sup>',     '<',    s)
    s = re.sub(r'</sup>',    '>',    s)
    s = re.sub(r'<a[^>]*?>', '',     s)
    s = re.sub(r'</a>',      '',     s)
    # s = re.sub(r'<[^>]+?>', '', s)
    s = re.sub(r'&#160;', '', s)
    s = re.sub(r'\*\)$', '', s)
    return s

print 'Searching for "' + words + '" ...'

params = {'lp'         : 'ende',
          'lang'       : 'en',
          'searchLoc'  : '0',
          'cmpType'    : 'relaxed',
          'relink'     : 'off',
          'sectHdr'    : 'off',
          'spellToler' : 'std',
          'search'     : words}

url = 'http://pda.leo.org/' + '?' + urllib.urlencode(params)

user_agent = 'Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:15.0) Gecko/20100101 Firefox/15.0.1'
headers = {'User-Agent' : user_agent}

request = urllib2.Request(url, headers=headers)
response = urllib2.urlopen(request)
content = response.read()

soup = BeautifulSoup(content, fromEncoding='utf-8')
results = soup.findAll('table', attrs={'class' : 'result'})

if len(results) == 0:
    print("No results found.")
    exit()

restable = results[0]

rows = restable.findAll('tr')
for row in rows:
    if len(row.findAll('th')) == 2:
        # header
        continue
    elif row.find('th') != None:
        # subheader
        contents = row.find('th')
        print '\n' + rev + re.sub(r' +$', '', contents.renderContents()) + nomode
    elif row.find('ul') != None:
        # base forms
        forms = row.findAll('li')
        for form in forms:
            print process(form.renderContents())
    else:
        # entry
        words = row.findAll('td')
        wordl = process(words[0].renderContents(encoding=None))

        esclen = 0
        for escseq in [bold, nomode, sitm, ritm]:
            l = re.findall(re.escape(escseq), wordl)
            esclen += len(l) * len(escseq)

        wordr = process(words[1].renderContents(encoding=None))

        print u'{0: <{width}}{1}'.format(wordl, wordr, width=40 + esclen)
